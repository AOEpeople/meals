name: CI

# Controls when the action will run. 
on: [ pull_request, workflow_dispatch ]

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Test with docker compose
        run: |
          export COMPOSE_INTERACTIVE_NO_CLI=true
          docker-compose pull app
          docker-compose up -d app
          docker-compose exec -T app composer install
          sleep 15
          docker-compose exec -T app app/console doctrine:schema:update --env=test --force
          docker-compose exec -T app bin/phpunit -d memory_limit=-1 -c app/config/commons/development/phpunit.xml
          docker-compose down -v --remove-orphans
          for f in app/build/logs/*.xml; do sed -i "s#/var/www/html/##g" "$f"; done
      - name: Upload coverage report artifact
        uses: actions/upload-artifact@v2.2.4
        if: always()
        with:
          name: reports
          path: app/build/
      - name: Publish unit-test results
        uses: EnricoMi/publish-unit-test-result-action@v1
        if: always()
        with:
          files: app/build/logs/junit.xml
      - name: Publish coverage
        uses: danhunsaker/clover-reporter-action@v0.2.17-clover
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          clover-file: app/build/logs/clover.xml
