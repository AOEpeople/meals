#!/bin/sh
set -e

echo "Setup Apache configuration"
envsubst < "/container/apache.conf" > "/etc/apache2/sites-enabled/meals.conf"

echo "Setup PHP configuration"
envsubst < "/container/php.ini" > "/usr/local/etc/php/conf.d/_meals.ini"

echo "Setup msmtp configuration"
envsubst < /container/msmtprc > /etc/msmtprc
chown www-data:www-data /etc/msmtprc
chmod 600 /etc/msmtprc

echo "Ensure dependencies"
composer install

echo "Setup folder and permissions"
mkdir -p app/cache app/logs
chown -R www-data:www-data app/cache app/logs

# first arg is `-f` or `--some-option`
if [ "${1#-}" != "$1" ]; then
	set -- apache2-foreground "$@"
fi

echo "Starting Apache"
exec "$@"
