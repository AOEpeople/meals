<?php

namespace Mealz\AccountingBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Mealz\UserBundle\Entity\Profile;

/**
 * TransactionRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class TransactionRepository extends EntityRepository
{
    const COLUMN_NAME = 'amount';

    /**
     * Get total amount of transactions. Prevent unnecessary ORM mapping.
     *
     * @param string $username
     * @return float
     * @throws \Doctrine\DBAL\DBALException
     */
    public function getTotalAmount($username)
    {
        $qb = $this->createQueryBuilder('t');
        $qb->select('SUM(t.amount) AS amount');
        $qb->andWhere('t.profile = :user');
        $qb->setParameter('user', $username);

        return floatval($qb->getQuery()->getSingleScalarResult());
    }

    /**
     * @param Profile $profile
     * @param int     $limit
     * @return mixed
     */
    public function getLastSuccessfulTransactions(Profile $profile, $limit = null)
    {
        $qb = $this->createQueryBuilder('t');
        $qb->select('t');
        $qb->andWhere('t.user = :user');
        $qb->setParameter('user', $profile);

        $qb->orderBy('t.date', 'desc');
        if (is_int($limit) === true) {
            $qb->setMaxResults($limit);
        }

        return $qb->getQuery()->execute();
    }


    /**
     * Get all successful transactions for period and profile
     *
     * @param \DateTime $minDate date from
     * @param \DateTime $maxDate date to
     * @param Profile   $profile user profile
     *
     * @return Transaction[]
     */
    public function getSuccessfulTransactionsOnDays(\DateTime $minDate, \DateTime $maxDate, Profile $profile)
    {
        $qb = $this->createQueryBuilder('t');
        $qb->select('t');

        $minDate = clone $minDate;
        $minDate->setTime(0, 0, 0);
        $maxDate = clone $maxDate;
        $maxDate->setTime(23, 59, 59);

        $qb->andWhere('t.date >= :minDate');
        $qb->andWhere('t.date <= :maxDate');
        $qb->setParameter('minDate', $minDate);
        $qb->setParameter('maxDate', $maxDate);

        $qb->andWhere('t.profile = :profile');
        $qb->setParameter('profile', $profile);

        $qb->orderBy('t.date', 'ASC');

        return $qb->getQuery()->execute();
    }

    /**
     * Get first name, last name and amount of transactions in the given time per user.
     *
     * @param \DateTime $minDate
     * @param \DateTime $maxDate
     * @param Profile   $profile
     * @return array
     */
    public function findUserDataAndTransactionAmountForGivenPeriod(\DateTime $minDate = null, \DateTime $maxDate = null, $profile = null)
    {
        $qb = $this->createQueryBuilder('t');
        $qb->select('p.username, p.firstName, p.name, SUM(t.amount) AS amount');
        $qb->leftJoin('t.profile', 'p');

        if ($minDate instanceof \DateTime) {
            $qb->andWhere('t.date >= :minDate');
            $qb->setParameter('minDate', $minDate);
        }

        if ($maxDate instanceof \DateTime) {
            $qb->andWhere('t.date <= :maxDate');
            $qb->setParameter('maxDate', $maxDate);
        }

        if ($profile instanceof Profile) {
            $qb->andWhere('p.username = :username');
            $qb->setParameter('username', $profile->getUsername());
        }

        $qb->groupBy('p.username');
        $qb->orderBy('p.name, p.firstName');
        $queryResult = $qb->getQuery()->getArrayResult();

        $result = array();

        foreach ($queryResult as $item) {
            $result[$item['username']] = array(
                'firstName' => $item['firstName'],
                'name' => $item['name'],
                'amount' => $item['amount'],
            );
        }

        return $result;
    }

    /**
     * Returns all transactions that were made between the given dates.
     * @param \DateTime $minDate
     * @param \DateTime $maxDate
     * @return array
     */
    public function findAllTransactionsInDateRange(\DateTime $minDate, \DateTime $maxDate) {
        $qb = $this->createQueryBuilder('t');
        $qb->select('t.date');

        $minDate = clone $minDate;
        $minDate->setTime(0, 0, 0);
        $maxDate = clone $maxDate;
        $maxDate->setTime(23, 59, 59);

        $qb->andWhere('t.date >= :minDate');
        $qb->andWhere('t.date <= :maxDate');
        $qb->setParameter('minDate', $minDate);
        $qb->setParameter('maxDate', $maxDate);

        $qb->orderBy('t.date', 'ASC');

        $queryResult = $qb->getQuery()->getArrayResult();

        $result = array();
        foreach ($queryResult as $item) {
            if (array_key_exists($item['date']->format('Y-m-d'), $result) == false) {
                $result[$item['date']->format('Y-m-d')] = $this->getAllTransactionsOnDay($item['date']);
            }
        }

        return $result;

    }

    /**
     * Helper function for findAllTransactionsInDateRange()
     * @param \DateTime $day
     * @return array
     */
    private function getAllTransactionsOnDay(\DateTime $day) {
        // Get all dates where transactions were made
        $qb = $this->createQueryBuilder('t');
        $qb->select('t.amount, t.date, p.firstName, p.name');
        $qb->leftJoin('t.profile', 'p');

        $minDate = clone $day;
        $minDate->setTime(0, 0, 0);
        $maxDate = clone $day;
        $maxDate->setTime(23, 59, 59);

        $qb->andWhere('t.date >= :minDate');
        $qb->andWhere('t.date <= :maxDate');
        $qb->setParameter('minDate', $minDate);
        $qb->setParameter('maxDate', $maxDate);

        $qb->orderBy('t.date', 'ASC');

        $queryResult = $qb->getQuery()->getArrayResult();

        $result = array();
        foreach ($queryResult as $item) {
            array_push($result, array(
                'amount' => $item['amount'],
                'date' => $item['date']->format('d.m.Y'),
                'firstName' => $item['firstName'],
                'name' => $item['name']
            ));
        }

        return $result;

    }
}
